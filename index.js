const AxeBuilder = require('axe-webdriverjs');
const AxeReports = require('axe-reports');
const WebDriver = require('selenium-webdriver');
const asyncEach = require('async-each-series');

// https://chromedriver.storage.googleapis.com/index.html
// https://chromedriver.storage.googleapis.com/index.html?path=90.0.4430.24/
var driver = new WebDriver.Builder()
  .forBrowser('chrome')
  .build();

var pages = ["action-buttons.html", "action-sheet-position.html", "action-sheet.html", "adaptive-grid-columnmenu.html", "adaptive-grid-edit-popup-no-height.html", "adaptive-grid-edit-popup.html", "adaptive-grid-filter-bool.html", "adaptive-grid-filter-multi.html", "adaptive-grid-filter.html", "adaptive-grid-pager.html", "adaptive-grid-search.html", "adaptive-scheduler-agenda.html", "adaptive-scheduler-day-resource-group.html", "adaptive-scheduler-day.html", "adaptive-scheduler-edit-no-height.html", "adaptive-scheduler-edit-time-zones.html", "adaptive-scheduler-edit.html", "adaptive-scheduler-month.html", "appbar.html", "autocomplete.html", "avatar-shape.html", "avatar-size.html", "avatar.html", "badge-misc.html", "badge-position.html", "badge-size.html", "badge.html", "barcode.html", "bottom-nav-colors.html", "bottom-nav-items.html", "bottom-nav-rtl.html", "bottom-nav.html", "breadcrumb-rtl.html", "breadcrumb.html", "buttongroup.html", "buttons-icon-text.html", "buttons-icon.html", "buttons-rtl.html", "buttons.html", "calendar-infinite-rtl.html", "calendar-infinite.html", "calendar-range-angular.html", "calendar-range-jquery.html", "calendar-range-react.html", "calendar-rtl.html", "calendar.html", "card-callout.html", "card-custom.html", "card-deck.html", "card-layout-horizontal.html", "card-layout-vertical.html", "card-rtl.html", "card-variants.html", "card.html", "chart.html", "chat-rtl.html", "chat-scrollable-deck.html", "chat.html", "checkbox.html", "chip-rtl.html", "chip.html", "color-gradient.html", "color-palette.html", "colorpicker-angular.html", "colorpicker-comboview.html", "colorpicker-jquery.html", "colorpicker-rtl.html", "combobox.html", "context-menu.html", "contextmenu-in-window.html", "dateinputs-angular.html", "dateinputs-react.html", "dateinputs-universal.html", "dateinputs.html", "dialog-action-buttons-react.html", "dialog-action-buttons.html", "dialog-in-window.html", "dialog-modal-angular.html", "dialog.html", "drawer-overlay-mini.html", "drawer-overlay.html", "drawer-rtl.html", "drawer.html", "drop-hint.html", "dropdown.html", "dropdownbutton.html", "dropdowns-popup-rtl.html", "dropdowns-popup.html", "dropdowns-universal.html", "dropdowntree.html", "dropzone.html", "edit-dialog-form.html", "editor-angular.html", "editor-dialog-view-source.html", "editor-find-replace.html", "editor-iFrameContent.html", "editor-jquery.html", "editor-react.html", "editor-table-wizard-accessibility.html", "expansion-panel-rtl.html", "expansion-panel.html", "fab-items.html", "fab-positions-angular.html", "fab-positions.html", "fab-rtl.html", "fab-shape-size.html", "fab-states.html", "fab.html", "filemanager-contextmenu.html", "filemanager-dialogs.html", "filemanager-drag-hint.html", "filemanager-gridview.html", "filemanager-listview.html", "filemanager-preview.html", "filemanager-toolbar.html", "filter.html", "floating-label-angular.html", "floating-label.html", "form-field-dateinputs-angular.html", "form-field-dateinputs-react.html", "form-field-dropdowns-angular.html", "form-field-dropdowns-react.html", "form-field-fieldset-angular.html", "form-field-fieldset-react.html", "form-field-inputs-angular-rtl.html", "form-field-inputs-angular.html", "form-field-inputs-react.html", "form-grid-layout.html", "form-misc-angular.html", "form-misc-react.html", "gantt-react.html", "gantt.html", "grid-angular-sticky-rows-and-cols.html", "grid-angular.html", "grid-column-menu-rtl.html", "grid-column-menu.html", "grid-editing-custom-editor.html", "grid-editing-popup.html", "grid-editing.html", "grid-filter-menu-multi-checkbox.html", "grid-filter-menu.html", "grid-filter-row.html", "grid-grouping.html", "grid-header-new-renderin-rtl.html", "grid-header-new-rendering.html", "grid-hierarchy.html", "grid-locked-columns-rtl.html", "grid-locked-columns.html", "grid-long-titles.html", "grid-multicolumn-headers.html", "grid-no-records.html", "grid-pager.html", "grid-react.html", "grid-rows-states.html", "grid-rtl-angular.html", "grid-rtl.html", "grid-sticky-columns-rtl.html", "grid-sticky-columns.html", "grid-sticky-multicolumn-headers.html", "grid-toolbar.html", "grid.html", "icons.html", "imageeditor-crop-pane.html", "imageeditor-resize-pane.html", "imageeditor.html", "inputs.html", "label-angular.html", "labels.html", "listbox-rtl.html", "listbox.html", "listgroup-rtl.html", "listgroup.html", "listview-loading.html", "listview.html", "loader-container-colors.html", "loader-container-overlay.html", "loader-container.html", "loader-sizes.html", "loader.html", "loading.html", "map.html", "mediaplayer.html", "menu-popup-angular.html", "menu-popup.html", "menu-vertical.html", "menu.html", "message-box.html", "multicolumncombobox-rtl.html", "multicolumncombobox.html", "multiselect.html", "notification-angular-custom.html", "notification-angular.html", "notification-jquery.html", "pager-responsive.html", "pager-rtl.html", "pager.html", "panelbar-angular.html", "panelbar-jquery.html", "panelbar-react.html", "panelbar-universal.html", "pdf-viewer-dialogs.html", "pdf-viewer.html", "pivotconfigurator.html", "pivotgrid.html", "popup-grouping-angular.html", "popup-grouping-rtl.html", "popup-grouping.html", "progressbar-blazor-vertical.html", "progressbar-blazor.html", "progressbar-horizontal-chunk.html", "progressbar-horizontal-indeterminate.html", "progressbar-horizontal-reverse.html", "progressbar-vertical.html", "progressbar.html", "qrcode.html", "quick-replies.html", "radiobutton-rtl.html", "radiobutton.html", "rating.html", "ripple.html", "scheduler-angular-agenda.html", "scheduler-angular-day-rtl.html", "scheduler-angular-edit-dialog-2.html", "scheduler-angular-edit-dialog.html", "scheduler-angular-month.html", "scheduler-angular-rtl-agenda.html", "scheduler-angular-rtl-month.html", "scheduler-angular-rtl.html", "scheduler-angular.html", "scheduler-flex-layout.html", "scheduler-jquery-agenda.html", "scheduler-react-agenda.html", "scheduler-react-day.html", "scheduler-react-month.html", "scheduler-react-timeline-multi.html", "scheduler-react-timeline.html", "scheduler-react-week.html", "scheduler-tooltip.html", "scheduler-year.html", "scheduler.html", "scrollview.html", "searchbox.html", "skeleton.html", "slider-css-vars.html", "slider-horizontal-rtl.html", "slider-vertical.html", "slider.html", "splitbutton.html", "splitter.html", "spreadsheet-dialogs.html", "spreadsheet-filter-menu.html", "spreadsheet.html", "stepper-horizontal-rtl.html", "stepper-states.html", "stepper-vertical-rtl.html", "stepper-vertical.html", "stepper.html", "switch.html", "tabstrip-rtl.html", "tabstrip.html", "taskboard-card.html", "taskboard-column.html", "taskboard-pane.html", "taskboard-resources.html", "taskboard-rtl.html", "taskboard.html", "textarea-angular.html", "textarea.html", "textbox-jquery.html", "textbox.html", "tilelayout-react.html", "tilelayout.html", "timeline-horizontal.html", "timeline-vertical-alternating.html", "timeline-vertical.html", "timepicker-rtl.html", "timepicker.html", "togglebutton.html", "toolbar-angular-rtl.html", "toolbar-angular.html", "toolbar-components-rtl.html", "toolbar-components.html", "toolbar-popup-rtl.html", "toolbar-popup.html", "toolbar-rtl.html", "toolbar.html", "tooltip-rtl.html", "tooltip-states.html", "tooltip.html", "treelist-aggregate-react.html", "treelist-aggregates.html", "treelist-react.html", "treelist.html","treemap.html", "treeview.html", "typography.html", "upload-angular.html", "upload-old-rendering-rtl.html", "upload-old-rendering.html", "upload-react.html", "upload-rtl.html", "upload.html", "virtual-list.html", "window-action-buttons-react.html", "window-angular-rtl.html", "window-angular.html", "window-rtl.html", "window.html", "wizard-horizontal.html", "wizard-vertical.html"];

function accessibilityCheck(pages) {
  let successUrls = [];

  return new Promise((resolve) => {
      asyncEach(pages, (page, next) => {
        driver
          .get("http://127.0.0.1:8080/tests/visual/" + page + "?theme=material")
          .then(function() {
            AxeBuilder(driver).withRules('color-contrast').analyze(function(err, results) {              
              AxeReports.processResults(results, 'csv', `./results/material/test-results-${page.replace(".html", "")}`, true);

              if (!results.violations.length) {
                successUrls.push(page);
              }

              next();
            });
          });         
      }, () => resolve({ valid: successUrls}));
  });
}

accessibilityCheck(pages).then((result) => {
  driver.quit();
  console.log("PASSED: " + result.valid.length);
});